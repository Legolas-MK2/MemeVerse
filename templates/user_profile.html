{% extends "base.html" %}

{% block title %}{{ user.username }}'s Profile{% endblock %}

{% block content %}
<div class="profile-container">
    <div class="profile-header">
        <div class="profile-picture-placeholder">
            <i data-feather="user"></i>
        </div>
        <div class="profile-info">
            <h1>{{ user.username }}</h1>
            <p>Member since {{ user.created_at.strftime('%B %Y') }}</p>
        </div>
    </div>

    <div class="liked-memes-section">
        <h2>Liked Memes</h2>
        <div class="liked-memes-grid" id="liked-memes-grid">
            <!-- Memes will be loaded here dynamically -->
        </div>
        
        <div class="loading-container" id="loading-container">
            {{ loading_svg|safe }}
        </div>
        
        <div class="load-more-container">
            <button id="load-more-btn" class="btn btn-primary">Load More</button>
        </div>
        
        <div class="no-memes" id="no-memes" style="display: none;">
            <p>No liked memes yet</p>
        </div>
        
        <div class="error-container" id="error-container" style="display: none;">
            <p>Error loading memes. Please try again.</p>
            <button class="btn btn-secondary" onclick="loadLikedMemes()">Retry</button>
        </div>
    </div>
</div>

<script>
    // Get the username from the URL
    const pathParts = window.location.pathname.split('/');
    const profileUsername = pathParts[pathParts.length - 1];
    
    let currentPage = 1;
    let isLoading = false;
    let hasMore = true;

    async function loadLikedMemes() {
        if (isLoading || !hasMore) return;
        
        isLoading = true;
        document.getElementById('loading-container').style.display = 'block';
        document.getElementById('error-container').style.display = 'none';
        
        try {
            const response = await fetch(`/api/liked-memes?username=${profileUsername}&page=${currentPage}&per_page=12`);
            if (!response.ok) throw new Error('Network response was not ok');
            
            const data = await response.json();
            const memeGrid = document.getElementById('liked-memes-grid');
            
            if (data.memes.length > 0) {
                data.memes.forEach(meme => {
                    const memeItem = document.createElement('div');
                    memeItem.className = 'meme-item';
                    
                    if (meme.media_type === 'video') {
                        memeItem.innerHTML = `
                            <div class="meme-media-container" data-media-type="video" data-media-id="${meme.id}">
                                <video src="/media/${meme.id}" 
                                       class="meme-thumbnail" 
                                       loop muted playsinline
                                       disablePictureInPicture
                                       controlsList="nodownload"></video>
                                <div class="media-type-indicator">
                                    <i data-feather="video"></i>
                                </div>
                            </div>
                        `;
                    } else {
                        memeItem.innerHTML = `
                            <div class="meme-media-container" data-media-type="image" data-media-id="${meme.id}">
                                <img src="/media/${meme.id}" alt="Liked meme" class="meme-thumbnail">
                                <div class="media-type-indicator">
                                    <i data-feather="image"></i>
                                </div>
                            </div>
                        `;
                    }
                    
                    memeItem.addEventListener('click', () => openMediaOverlay(meme));
                    memeGrid.appendChild(memeItem);
                });
                
                currentPage++;
                hasMore = data.hasMore;
                
                if (!hasMore) {
                    document.getElementById('load-more-btn').style.display = 'none';
                }
                
                if (typeof feather !== 'undefined') {
                    feather.replace();
                }
            } else {
                document.getElementById('no-memes').style.display = 'block';
                document.getElementById('load-more-btn').style.display = 'none';
            }
        } catch (error) {
            console.error('Error loading memes:', error);
            document.getElementById('error-container').style.display = 'block';
        } finally {
            isLoading = false;
            document.getElementById('loading-container').style.display = 'none';
        }
    }

    function openMediaOverlay(meme) {
        // Create overlay element
        const overlay = document.createElement('div');
        overlay.className = 'media-overlay';
        overlay.id = 'media-overlay';
        
        // Create overlay content
        let overlayContent;
        if (meme.media_type === 'video') {
            overlayContent = `
                <div class="overlay-content">
                    <video src="/media/${meme.id}" 
                           controls autoplay 
                           disablePictureInPicture
                           controlsList="nodownload"></video>
                </div>
            `;
        } else {
            overlayContent = `
                <div class="overlay-content">
                    <img src="/media/${meme.id}" alt="Liked meme">
                </div>
            `;
        }
        
        // Add unlike button for authenticated users
        const unlikeButton = `
            <button class="overlay-unlike-button" data-meme-id="${meme.id}">
                <i data-feather="heart"></i> Unlike
            </button>
        `;
        
        overlay.innerHTML = `
            <div class="overlay-close">Ã—</div>
            ${overlayContent}
            ${unlikeButton}
        `;
        
        // Add close functionality
        overlay.querySelector('.overlay-close').addEventListener('click', () => {
            document.body.removeChild(overlay);
        });
        
        // Add unlike functionality
        overlay.querySelector('.overlay-unlike-button').addEventListener('click', async (e) => {
            e.stopPropagation();
            const memeId = e.target.closest('.overlay-unlike-button').dataset.memeId;
            try {
                const response = await fetch(`/api/like/${memeId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    // Remove the meme from the grid
                    const memeElements = document.querySelectorAll(`.meme-media-container[data-media-id="${memeId}"]`);
                    memeElements.forEach(el => {
                        el.closest('.meme-item').remove();
                    });
                    
                    // Close overlay
                    document.body.removeChild(overlay);
                } else {
                    console.error('Failed to unlike meme');
                }
            } catch (error) {
                console.error('Error unliking meme:', error);
            }
        });
        
        // Close when clicking outside content
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
                document.body.removeChild(overlay);
            }
        });
        
        // Add to document
        document.body.appendChild(overlay);
        
        // Initialize feather icons
        if (typeof feather !== 'undefined') {
            feather.replace();
        }
    }

    // Initial load
    loadLikedMemes();

    // Load more button click
    document.getElementById('load-more-btn').addEventListener('click', loadLikedMemes);

    // Infinite scroll
    window.addEventListener('scroll', () => {
        const { scrollTop, scrollHeight, clientHeight } = document.documentElement;
        if (scrollTop + clientHeight >= scrollHeight - 100 && hasMore) {
            loadLikedMemes();
        }
    });
</script>
{% endblock %}
